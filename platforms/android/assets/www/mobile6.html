<!doctype html>
<html>
<head>

    <title>Givahoy</title>


    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
    <link rel="stylesheet" href="./themes/jquery.mobile.icons.min.css"/>
    <link rel="stylesheet" href="./themes/main.css"/>

</head>
<body>
<div data-role="page" id="givepage">
    <div data-role="header">
        <img src="givahoybanner.png" width="50%" height="auto"/>
    </div>
    <br>
    <br>
    <br>
    <div ng-controller="givahoyAppController">
       <!-- <button ng-click="refreshLocation()">Refresh location</button> -->
        <div id="locationWrapper">
            <img id="refreshLocation" src="images/refresh.png" ng-click="refreshLocation()">
            <select id="locations" data-corners="false" data-shadow="false">
                <option id="defaultOption" disabled selected>Select your option</option>
                <option ng-repeat="charity in ServerData.charities | orderBy:'type'" value={{charity.value}}>{{charity.name}} ({{charity.location}})</option>
            </select>


        </div>

        <br>
        <br>
        <div class="button-block">
            <div class="round-button">
                <div class="round-button-circle"><a ng-click="makeTransaction(1)" class="round-button">$1</a></div>
            </div>
            <div class="round-button">
                <div class="round-button-circle"><a ng-click="makeTransaction(2)" class="round-button">$2</a></div>
            </div>
            <div class="round-button">
                <div class="round-button-circle"><a ng-click="makeTransaction(5)" class="round-button">$5</a></div>
            </div>
        </div>
        <div class="button-block">
            <div class="round-button">
                <div class="round-button-circle"><a ng-click="makeTransaction(10)" class="round-button">$10</a></div>
            </div>
            <div class="round-button">
                <div class="round-button-circle"><a ng-click="makeTransaction(20)" class="round-button">$20</a></div>
            </div>
            <!---<div class="round-button"><div class="round-button-circle"><a onclick=" class="round-button">$x</a></div></div>
            Put this back in when I decide to write a popup for other amounts
            --->
        </div>
        <div class="button-block">
            <div class="round-button">
                <div class="round-button-circle"><a ng-click="makeTransaction(0)" class="round-button"
                                                    font-family="Arial">&hearts;</a></div>
            </div>
        </div>
        <div>
            <p id="availbal">Available Balance: ${{ServerData.localData.userBalance}}</p>
        </div>
    </div>
    <div data-role="footer" data-id="foo1" data-position="fixed">
        <div data-role="navbar" class="navbar">
            <ul>
                <li><a href="#givepage" class="ui-btn-active ui-state-persist">Give &hearts;</a></li>
                <li><a href="#historypage">History</a></li>
                <li><a href="#settingspage">Settings</a></li>
            </ul>
        </div>
    </div>
</div>
<div data-role="page" id="historypage">
    <div data-role="header">
        <img src="givahoybanner.png" width="50%" height="auto"/>
    </div>
    <h2>To be implemented</h2>
    <div data-role="footer" data-id="foo1" data-position="fixed">
        <div data-role="navbar" class="navbar">
            <ul>
                <li><a href="#givepage">Give &hearts;</a></li>
                <li><a href="#historypage" class="ui-btn-active ui-state-persist">History</a></li>
                <li><a href="#settingspage">Settings</a></li>
            </ul>
        </div>
    </div>
</div>
<div data-role="page" id="settingspage">
    <div data-role="header">
        <img src="givahoybanner.png" width="50%" height="auto"/>
    </div>
    <h2>To be implemented</h2>
    <div data-role="footer" data-id="foo1" data-position="fixed">
        <div data-role="navbar" class="navbar">
            <ul>
                <li><a href="#givepage">Give &hearts;</a></li>
                <li><a href="#historypage">History</a></li>
                <li><a href="#settingspage" class="ui-btn-active ui-state-persist">Settings</a></li>
            </ul>
        </div>
    </div>
</div>


    <div class="modal ui-overlay-shadow">
        <div class="exitButton"></div>
        <div class="container"></div>
    </div>
<div class="modal-underlay"></div>

<script type="text/javascript" src="lib/angular.min.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="libs/evothings/evothings.js"></script>
<script type="text/javascript" src="libs/evothings/ui/ui.js"></script>
<script type="text/javascript" src="lib/jquery.min.js"></script>
<script type="text/javascript" src="lib/axios/dist/axios.standalone.js"></script>
<script type="text/javascript" src="lib/CryptoJS/rollups/hmac-sha256.js"></script>
<script type="text/javascript" src="lib/CryptoJS/rollups/sha256.js"></script>
<script type="text/javascript" src="lib/CryptoJS/components/hmac.js"></script>
<script type="text/javascript" src="lib/CryptoJS/components/enc-base64.js"></script>
<script type="text/javascript" src="lib/moment/moment.js"></script>
<script type="text/javascript" src="lib/url-template/url-template.js"></script>
<script type="text/javascript" src="lib/apiGatewayCore/sigV4Client.js"></script>
<script type="text/javascript" src="lib/apiGatewayCore/apiGatewayClient.js"></script>
<script type="text/javascript" src="lib/apiGatewayCore/simpleHttpClient.js"></script>
<script type="text/javascript" src="lib/apiGatewayCore/utils.js"></script>
<script type="text/javascript" src="apigClient.js"></script>

<script type="text/javascript" src="src/models.js"></script>
<script type="text/javascript" src="src/app.js"></script>

<script>
    var mybal = 0;
    $( document ).ready(function() {

    });
    $(document).bind("mobileinit", function() {
        $.mobile.defaultPageTransition = 'none';
    });

    function getSelectedLocation(){
        selectedLocation =  $('#locations')
                .find($('option:selected'));

        return selectedLocation;
    }

    function updateViewBalance(){
        console.log("mybal = " + mybal);
        $('#availbal').text('Available Balance: $' + mybal);
    }

    function addLocationOptionToTopOfList(value, name, location){
        var defaultSelected = true;
        var nowSelected = true;
        var listedName = name + ' (' + location + ')';

        var newLocation = new Option(listedName, value,defaultSelected, nowSelected);

        $('#locations').prepend(newLocation).change();
    }

    function initiateTrans(vamount){
        /*
         *
         * MUST BE MODIFIED WHEN BALANCE IS FUNCTIONAL
         *
         * */
        if (mybal + 50 <= vamount) {
            alert('Insufficient Funds');
            return;
        }
        navigator.notification.confirm(
                "Are you sure you want to donate $" + vamount + " to " + getSelectedLocation().text() + "?",
                function(buttonIndex){
                    if(buttonIndex==1){
                        /*
                         Create processing page

                         */
                        transactionData = transactionDataBody(vamount, getSelectedLocation().val());
                        makeTrans(transactionData)
                    }
                });
    }


    $(" .modal .exitButton").click(function(){
        clearModal();
    });

    function clearModal(){
        console.log("clearModal called");
        $(".modal")
                .removeClass("loading")
                .removeClass("completedTransaction")
                .removeClass("dismissible");
    }
    function showTransactionProcessModal(){

        /*        $('#mySelect').append( new Option(text,val,defaultSelected,nowSelected) );
         optionHtml = '<option value= '+ value + '>' + name + ' (' + location + ')</option>';
         //adds option to list of locations
         $('#locations').prepend(optionHtml); */

        clearModal();
        $(".modal")
                .addClass("loading");
        $(".modal .container")
                .text("Your Transaction is being Processed")
                .prepend('<img id="theImg" src="http://i.stack.imgur.com/FhHRx.gif" /><br>');

    }

    function showLoadingModal(message){
        clearModal();
        $(".modal")
                .addClass("loading");
        $(".modal .container")
                .text(message)
                .prepend('<img id="theImg" src="http://i.stack.imgur.com/FhHRx.gif" /><br>');

    }

    function showTransactionCompletedModal(charity, amount){
        clearModal();
        $(".modal")
                .addClass("completedTransaction")
                .addClass("dismissible");
        $(".modal .container")
                .text("Thank you for your $" + amount + " donation to " + charity)
                .prepend('<div class="exit"></div><img id="theImg" src="images/heart.png" /><br>');
    }
    function makeTrans(body) {
        console.log("Transaction initiated for " + getSelectedLocation().val());
        //mybal = mybal - vamount;
        //updateViewBalance();
        //Transaction record is Date, Amount and destination

        showTransactionProcessModal();

        var apigClient = apigClientFactory.newClient();


        //alert (JSON.stringify(body));
        apigClient.allpurposePost({}, body, {})
                .then(function (result) {
                    //This is where you would put a success callback
                    var myresult = result;
                    mybal = myresult.data.mbalance.mbalance;
                    for (var i = 0, len = myresult.data.sresult.length; i < len; i++) {
                        //You can now access individual properties like this:
                        //var json = $.parseJSON(data.locationlist.location[i]);
                        if (i == 0) {
                            var output = '';
                        }

                        addLocationOptionToTopOfList(myresult.data.sresult[i].llocationid, myresult.data.sresult[i].slocationname);
                    }
                    updateViewBalance();

                    if (!localStorage.uid) {
                        localStorage.setItem("uid", myresult.data.mbalance.vuid);
                    }
                    localStorage.setItem("vrandom", myresult.data.sresult.checker);
                    //alert('Payment: ' + myresult.data.sresult.status + ' $' + body.mvalue + ' to ' + $('#location option:selected').text() + '!');
                    showTransactionCompletedModal(getSelectedLocation().text(), body.mvalue);
                    console.log(myresult);
                }).catch(function (result) {
            //This is where you would put an error callback
            alert("Sorry, there was a problem processing your donation.");
            clearModal();
            console.log(result);
        });
    }

/*    function createJsonForBeacons(beaconIdArray){
        var jsonMessage = [];
        var loopcount = beaconIdArray.length;
        for(var i= 0; i < loopcount; i++){
            jsonMessage.push(
                    {"beaconid": beaconIdArray[i]}
            );
        }
        return jsonMessage;
    }*/
    function setLocation(location){
        userLocation.latitude = location.coords.latitude;
        userLocation.longitude = location.coords.longitude;
    }

    function showPosition() {
        nearbyBeacons = createJsonForBeacons(getBeacons());

        var body = {
            //This is where you define the body of the request
            "saction": "GetLocation",
            "llatitude": userLocation.latitude,
            "llongitude": userLocation.longitude,
            "tuuid": device.uuid,
            "vuid": window.localStorage.getItem('uid'), //Currently coming back as null
            "vrandom": window.localStorage.getItem('vrandom'),
            "beaconlist": createJsonForBeacons(getBeacons())
        };

            console.log(JSON.stringify(body));

        console.log("Initial data collection started");


        var apigClient = apigClientFactory.newClient();
        apigClient.allpurposePost({}, body, {})
                .then(function (result) {
                    //This is where you would put a success callback
                    //alert(result.data.locationlist.location.length);
                    //When DOM loaded we attach click event to button
                    //after button is clicked we download the data
                    var myresult = result;
                    console.log(JSON.stringify(myresult));
                    mybal = myresult.data.mbalance.mbalance;


                    if(myresult.data.sresult){
                        for (var i = 0; i < myresult.data.sresult.length; i++) {
                            if (i == 0) {
                                var output = '';
                            }
                            addLocationOptionToTopOfList(
                                    myresult.data.sresult[i].linstancelocationid,
                                    myresult.data.sresult[i].sinstancename,
                                    myresult.data.sresult[i].slocationname
                            );
                        }
                    }

                    updateViewBalance();
                    if (!localStorage.uid) {
                        localStorage.setItem("uid", myresult.data.mbalance.vuid);
                    }
                    clearModal();
                }).catch(function (result) {
            alert("There was an error getting data from the server");
            clearModal();
            console.log(result);
        });

    }

    function showPositionOnError(error) {
        switch (error.code) {
            case error.PERMISSION_DENIED:
                console.log("Error getting position: Permission denied");
                break;
            case error.POSITION_UNAVAILABLE:
                console.log("Error getting position: Permission unavailable");
                break;
            case error.TIMEOUT:
                console.log("Error getting position: Timed out");
                break;
            case error.UNKNOWN_ERROR:
                console.log("Error getting position: Unknown error");
                break;
        }
    }







    var beacons = {};

    function getBeacons(){
        var beaconList = [];
        var beacon;
        for(beaconKey in beacons){
            beacon = beacons[beaconKey];
            beaconID = uint8ArrayToString(beacon.bid);
            beaconList.push(beaconID);
        }
        return beaconList;
    }

    function startBeaconScan(){
        evothings.eddystone.startScan(
            function(beacon){
                var listed = false;
                console.info("Beacon transmission detected");
                if(!beacons[beacon.address] && isGivahoyBeacon(beacon)){
                    beacons[beacon.address] = beacon;
                    console.log("beacon pushed to array");
                }
            },
            function(error){
                alert('Scan error: ' + error);
            }
        )

    }

    /*
        A promise wrapper for the geolocation callback
    */
    function initialiseLocation(){
        return new Promise(function(resolve, reject) {
            navigator.geolocation.getCurrentPosition(
                    function (location) {
                        setLocation(location);
                        console.log("Success");
                        resolve();
                    },
                    function (error) {
                        showPositionOnError(error);
                        console.log("Failed");
                        reject(error);
                    }
            );
        });
    }


    function initialiseBeacons(){
        return new Promise(function(resolve, reject){
            startBeaconScan();
            setTimeout(function(){
                var beacons = createJsonForBeacons(getBeacons());
                return resolve(beacons);
            }, 10000);
        });
    }

    function initialiseCharityRetrieval(){
        var attemptedLocation = false;
        var attemptedBeacons = false;
        var charityRequest = new ServerDataRequestBuilder();

        if (typeof navigator.geolocation === undefined) {
            console.log("location disabled");
            attemptedLocation = true;
            CallServerIfReady(attemptedLocation, attemptedBeacons);
        }
        else {
            initialiseLocation()
                    .then(function(){
                            console.log("Location promise returned success");
                            attemptedLocation = true;
                            charityRequest.useLocation(userLocation);
                            CallServerIfReady(attemptedLocation, attemptedBeacons);
                        },
                        function(error){
                            console.log("Location promise returned fail");
                            attemptedLocation = true;
                            CallServerIfReady(attemptedLocation, attemptedBeacons);
                        }
                    );
        }

        if(cordova.plugins.BluetoothStatus.BTenabled !== true) {
            console.log("bluetoothLE is not enabled, skipping beacon scan");
            attemptedBeacons = true;
            CallServerIfReady(attemptedLocation, attemptedBeacons);
        }
        else{
            initialiseBeacons()
                .then(function(beacons){
                    console.log("Beacon promise returned success");
                    attemptedBeacons = true;
                    charityRequest.useBeacons(beacons);
                    CallServerIfReady(attemptedLocation, attemptedBeacons);
                },
                function(error){
                    console.log("Beacon promise returned fail");
                    console.log(error);
                    attemptedBeacons = true;
                    CallServerIfReady(attemptedLocation, attemptedBeacons);
                }
            )
        }
    }

    function CallServerIfReady(location, beacon){
        console.log(location);
        console.log(beacon);
        if(location && beacon){
            showPosition();
        }

    }


    function onDeviceReady() {
        $()
        console.info("onDeviceReady Called");
        cordova.plugins.BluetoothStatus.initPlugin();
        angular.bootstrap($('html'), ["givahoyApp"]);

    }

    document.addEventListener("deviceready", onDeviceReady, false);
</script>
<script type="text/javascript" src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
</body>
</html>
