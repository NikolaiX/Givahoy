<!DOCTYPE html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>QUnit Example</title>
    <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-1.22.0.css">
</head>
<body>
<div id="qunit"></div>
<div id="qunit-fixture"></div>
<script src="src/models.js"></script>
<script src="src/app.js"></script>
<script src="libs/QUnit/qunit-1.22.0.js"></script>
</body>
<script>

    //Mocks server for testing
    server = function(body){
        var response;
        var sresult = [];

        switch (body.saction) {
            case "GetLocation":
                if (parseInt(body.llatitude) == 1 && parseInt(body.llongitude) == 1) {

                    sresult.push({
                        "linstanceid": 5,
                        "linstancelocationid": 6,
                        "locsort": 10,
                        "loctype": "l",
                        "nlatitude": 1,
                        "nlongitude": 1,
                        "sinstancename": "Mocked Charity",
                        "slocationname": "Mock location"
                    });
                }
                if (body.beaconList) {
                    for (var beacon in body.beaconList) {
                        if (body.beaconList.hasOwnProperty(beacon)){
                            if(body.beaconList[beacon].beaconid === 1234){
                                sresult.push({
                                    "linstanceid": 7,
                                    "linstancelocationid": 8,
                                    "locsort": 20,
                                    "loctype": "b",
                                    "nlatitude": 0,
                                    "nlongitude": 0,
                                    "sinstancename": "Mocked Beacon",
                                    "slocationname": "Mock location"
                                });
                            }else if(body.beaconList[beacon].beaconid === 1236){
                                sresult.push({
                                    "linstanceid": 9,
                                    "linstancelocationid": 10,
                                    "locsort": 30,
                                    "loctype": "b",
                                    "nlatitude": 0,
                                    "nlongitude": 0,
                                    "sinstancename": "Mocked Beacon 2",
                                    "slocationname": "Mock location"
                                });
                            }
                        }
                    }
                }
                response ={
                    data: {
                        status: "Success: GetLocation",
                        "mbalance":{
                            "mbalance":5,
                            "vuid":null
                        },
                        sresult
                    }
                };
                break;
            default:
                response ={
                    data: {
                        status: "Error"
                    }
                };

        }
        //myresult.data.sresult[i]
        //myresult.data.status

        return response;
    };
        //Mock user location
    userLocation ={
        "llatitude": 1,
        "llongitude": 1

    };

    deviceID ={
        "tuuid": 1,
        "vuid": 1, //Currently coming back as null
        "vrandom": 1
    };

    var mockGet1ValidBeacon = function(){
        this.beaconList = [];
        this.beaconList.push(1234);
        this.beaconList.push(1235);

        return this.beaconList;
    }
    var mockGet2ValidBeacons = function(){
        this.beaconList = [];
        this.beaconList.push(1234);
        this.beaconList.push(1235);
        this.beaconList.push(1236);

        return this.beaconList;
    }

/*    QUnit.test("Test Mock Server", function( assert ) {
        var request = ServerDataRequestBuilder()
                .useBeacons()=
                .useLocation()
                .build();

    });*/

    QUnit.test("Charity request builder - location", function( assert ) {
        var expectedOutput = {
            "saction": "GetLocation",
            "tuuid": 1,
            "vuid": 1,
            "vrandom": 1,
            "llatitude": 1,
            "llongitude": 1
        };
         var actualOutput = new ServerDataRequestBuilder()
                 .useLocation(userLocation)
                 .build();

        assert.deepEqual(actualOutput,expectedOutput);
    });

    QUnit.test("Charity request builder - beacon", function( assert ) {
        var getBeacons = mockGet1ValidBeacon();


        var expectedOutput = {
            "saction": "GetLocation",
            "tuuid": 1,
            "vuid": 1,
            "vrandom": 1,
            "beaconList":[
                {"beaconid": 1234},
                {"beaconid": 1235}
            ]
        };

        var actualOutput = new ServerDataRequestBuilder()
                .useBeacons(getBeacons)
                .build();

        assert.deepEqual(actualOutput,expectedOutput);
    });

    QUnit.test("Charity request builder - All options", function( assert ) {
        var getBeacons = mockGet1ValidBeacon();
        var expectedOutput = {
            "saction": "GetLocation",
            "tuuid": 1,
            "vuid": 1,
            "vrandom": 1,
            "llatitude": 1,
            "llongitude": 1,
            "beaconList":[
                {"beaconid": 1234},
                {"beaconid": 1235}
            ]
        };

        var actualOutput = new ServerDataRequestBuilder()
                .useBeacons(getBeacons)
                .useLocation(userLocation)
                .build();

        assert.deepEqual(actualOutput,expectedOutput);
    });
    QUnit.test("Test Mock Server", function( assert ) {
        var getBeacons = mockGet1ValidBeacon();
        var charityRequest = new ServerDataRequestBuilder()
                .useBeacons(getBeacons)
                .useLocation(userLocation)
                .build();
        var actualOutput = server(charityRequest);
        assert.equal(actualOutput.data.sresult.length, 2);

        charityRequest = new ServerDataRequestBuilder()
                .useLocation(userLocation)
                .build();
        var actualOutput = server(charityRequest);
        assert.equal(actualOutput.data.sresult.length, 1);

        charityRequest = new ServerDataRequestBuilder()
                .useBeacons(getBeacons)
                .build();
        var actualOutput = server(charityRequest);
        assert.equal(actualOutput.data.sresult.length, 1)
    });

    QUnit.test("Test Creating Charities From Json", function( assert ) {
        var getBeacons = mockGet1ValidBeacon();
        var charityRequest = new ServerDataRequestBuilder()
                .useBeacons(getBeacons)
                .useLocation(userLocation)
                .build();
        var json = server(charityRequest);
        var actualOutput = ServerResultGetCharities(json);


        var numberOfCharitiesActual = actualOutput.length;
        var numberOfCharitiesExpected = 2;
        assert.equal(numberOfCharitiesActual,numberOfCharitiesExpected);
        var pass = false;
        if((actualOutput[0].name == "Mocked Charity" && actualOutput[1].name == "Mocked Beacon") ||
                (actualOutput[0].name == "Mocked Beacon" && actualOutput[1].name == "Mocked Charity")){
            pass = true;
        }

        assert.ok(pass);
    });

    QUnit.test("Test Server Cache", function( assert ) {
        //Test that data is downloaded and stored
        var getBeacons = mockGet1ValidBeacon();
        var charityRequest = new ServerDataRequestBuilder()
                .useBeacons(getBeacons)
                .useLocation(userLocation)
                .build();
        var cache = new ServerCache(charityRequest);

        var numberOfCharitiesActual = cache.localCharities.length;
        var numberOfCharitiesExpected = 2;
        assert.equal(numberOfCharitiesActual,numberOfCharitiesExpected);

        //Test that data is updated with new info
        getBeacons = mockGet2ValidBeacons();
        charityRequest = new ServerDataRequestBuilder()
                .useBeacons(getBeacons)
                .useLocation(userLocation)
                .build();
        cache.update(charityRequest);

        numberOfCharitiesActual = cache.localCharities.length;
        numberOfCharitiesExpected = 3;
        assert.equal(numberOfCharitiesActual,numberOfCharitiesExpected);

        //Test that cache persists when server returns with an error
        alert = function(){};
        charityRequest = new ServerDataRequestBuilder()
                .useBeacons(getBeacons)
                .useLocation(userLocation)
                .triggerError()
                .build();
        cache.update(charityRequest);
        assert.equal(numberOfCharitiesActual,numberOfCharitiesExpected);

    });
</script>

</html>